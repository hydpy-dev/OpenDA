# Spatial Noise Model

The [OpenDA extension](https://github.com/hydpy-dev/OpenDA#readme) for [HydPy](https://github.com/hydpy-dev/hydpy#readme)
also provides a specialized implementation of a noise model (to be used in the _state_ of a black box model configuration) which is 
an adaption of OpenDA's 'maps noise model (_org.openda.noiseModels.MapsNoiseModelFactory_) with the following features:
* generalization of the maps noise model by allowing for arbitrarily distributed elements (instead of only regular grids)
* separation of the definition of a noise exchange item and it's spatial distribution (a.k.a geometry)
* specialized support for HydPy by mapping a file of locations to item names generated by HydPy

## Usage

The implementation class _org.hydpy.openda.noise.SpatialNoiseModelFactory_ is intended to be used as the implementation class of a _noiseModel_ 
element within the _state_ of a black box model configuration.

For example:
```xml
      <noiseModel
              id="NoiseModelLZ"
              className="org.hydpy.openda.noise.SpatialNoiseModelFactory"
              workingDirectory=".">
        <configFile>spatialNoise.xml</configFile>
        <exchangeItems>
          <exchangeItem id="noise_lz" operation="add">
            <modelExchangeItem id="lz"/>
          </exchangeItem>
        </exchangeItems>
      </noiseModel> 
```

## Configuration

A xml file must be specified (via the _configFile_ tag) that validates by the [xml schema of the spatial noise model](https://raw.githubusercontent.com/hydpy-dev/OpenDA/master/extensions/HydPyOpenDABBModelWrapper/src/main/resources/schemas/spatialNoiseModel.xsd). 
The configuration essentially defines a list of (noise-) exchange items, a list of geometries which are referenced by the exchange items, and an (optional) simulation time span.

For the general concept and the simulation time span, see the documentation and examples of the original maps noise model.

### Noise Items

Each noise item defines an exchange item that can be used within the state of a black box model instance and allows to defined the following
attributes:
* id: Unique identifier of this exchange item
* quantity: name of the quantity this item represents
* unit: physical unit of the values
* standardDeviation: the standard deviation used to compute white noise
* timeCorrelationScale: FIXME
* timeCorrelationScaleUnit: FIXME
* initialValue: the starting value for the first computation of noise
* geometry: reference to a geometry defined in this configuration (by its id attribute)

For example:
```xml
  <noiseItem
          id="noise_lz"
          quantity="LZ"
          unit="mm"
          standardDeviation="0.2"
          timeCorrelationScale="10.0"
          timeCorrelationScaleUnit="days"
          initialValue="0.0"
          geometry="my_fancy_geometry" /> 
```

### Geometries

Each geometry element defines a spatial distribution of the entries of the data vector of the noise (typically representing the locations of model elements or observation stations).
Geometry elements can be referenced from multiple noise items, if they should represent the same spatial distribution.
A geometry allows to define the following general attributes:
* id: its unique identifier, used to be referenced by noise items
* coordinates: the type of coordinate system which coordinates of this geometry are in. Allowed values are _xy_ and _wgs84_. Depending on this type, the distance between points is computed as either euclidian (_xy_) or spherical (_wgs84_).
* horizontalCorrelationScale: FIXME
* horizontalCorrelationScaleUnit: unit of the _horizontalCorrelationScale_. Allowed values are _cm_, _m_ and _km_.

For example:
```xml
  <geometry
          id="my_fancy_geometry"
          coordinates="xy"
          horizontalCorrelationScale="100000.0"
          horizontalCorrelationScaleUnit="m">
    <pointsHydPy factory="org.hydpy.openda.noise.points.HydPySpatialNoisePointsGeometryFactory"
            modelExchangeItem="lz"
            locationsFile="locations_lz.txt"/>
  </geometry> 
```

The actual spatial distribution is then defined in sub-elements that allow for different situations.
The attributes and further structure of the sub-element depends on its implementation, but has at least the following attribute:
* factory: Any fully qualified name of a class implementing _org.hydpy.openda.noise.ISpatialNoiseGeometryFactory_

It is also possible to implement your own geometry type by providing an implementation class.
The configuration parser will ignore the actual name of the sub-element and will work as long as the _factory_ attribute is present.   

The following predefined geometry types are shipped with this extension. See the [xml schema](https://raw.githubusercontent.com/hydpy-dev/OpenDA/master/extensions/HydPyOpenDABBModelWrapper/src/main/resources/schemas/spatialNoiseModel.xsd) for further details.
* grid: A regular grid of points
* points: An arbitrary list of point coordinates
* pointsHydPy: Specialized spatial distribution of (arbitrary) 'point' locations, where the order (within the noise vector) will be
        fetched from HydPy.

#### Notes on pointsHydPy

The pointsHydPy geometry type is specially suited to work with HydPy exchange items. As the actual model exchange item, onto which the noise will later be added,
is defined and fetched from HydPy, the order of data entries is determined by the HydPy model. To avoid a manual mapping between coordinates and
model elements, this geometry type allow to map locations to elements via their names. The user than only needs to provide a mapping file between element names and
spatial locations. See the schema for further details.

### Saving internal state (or rather not)

The root element of the configuration file, _spatialNoiseModelConfig_, allows for an additional boolean attribute _suppressInternalStateSaving_.
Setting this attribute to _true_ will suppress the saving/restoring of the internal state of the noise model.

This is necessary for using a noise model in the state definition of some algorithms (e.g. the ParticleFilter), 
which currently is implemented by copying state between ensemble instances. However, due to the order in which the noise
is computed, added to the deterministic model and then the deterministic model is computed, this can lead to a 
(most probably unintended) collapse of the ensemble field.

**Note**: saving/restoring the state is also used by OpenDA to implement restarting model runs in an operation framework, e.g. for the use case of forecasting.
 Disabling of restoring the state will also has an impact on this restart functionality.